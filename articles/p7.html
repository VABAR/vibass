<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practical 7: Bayesian Hierarchical Modelling • vibass</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Practical 7: Bayesian Hierarchical Modelling">
<meta property="og:description" content="vibass">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vibass</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.43</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/p1.html">Practical 1: Binary data</a>
    </li>
    <li>
      <a href="../articles/p2count.html">Practical 2: Count data</a>
    </li>
    <li>
      <a href="../articles/p2normal.html">Practical 2: Normal data</a>
    </li>
    <li>
      <a href="../articles/p3.html">Practical 3: Bayesian linear regression</a>
    </li>
    <li>
      <a href="../articles/p4.html">Practical 4: Simualtion-based Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/p5.html">Practical 5: Numerical approaches</a>
    </li>
    <li>
      <a href="../articles/p6.html">Practical 6: Software and GLMs</a>
    </li>
    <li>
      <a href="../articles/p7.html">Practical 7: Bayesian Hierarchical Modelling</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/VABAR/vibass/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Practical 7: Bayesian Hierarchical
Modelling</h1>
                        <h4 data-toc-skip class="author">VIBASS</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/VABAR/vibass/blob/HEAD/vignettes/p7.Rmd" class="external-link"><code>vignettes/p7.Rmd</code></a></small>
      <div class="hidden name"><code>p7.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="bayesian-hierarchical-modelling">Bayesian Hierarchical Modelling<a class="anchor" aria-label="anchor" href="#bayesian-hierarchical-modelling"></a>
</h2>
<p>In this last practical we will consider the analysis of Bayesian
hierarchical models. As explained in the previous lecture, hierarchical
models provide a convenient tool to define models so that the different
sources of variation in the data are clearly identified. Bayesian
inference for highly structured hierarchical models can be difficult and
may require the use of Markov chain Monte Carlo methods.</p>
<p>However, packages such as <code>BayesX</code> and <code>INLA</code>,
to mention just two, provide a very convenient way to fit and make
inference about certain types of Bayesian hierarchical models. We will
continue using BayesX, although you can try out using <code>INLA</code>
if you look at the optional, additional material in Practical 8.</p>
</div>
<div class="section level2">
<h2 id="linear-mixed-models">Linear Mixed Models<a class="anchor" aria-label="anchor" href="#linear-mixed-models"></a>
</h2>
<p>Linear mixed models were defined in the lecture as follows:</p>
<p><span class="math display">\[
Y_{ij} = X_{ij}\beta +\phi_i+\epsilon_{ij}
\]</span></p>
<p>Here, Y_{ij} represents observation <span class="math inline">\(j\)</span> in group <span class="math inline">\(i\)</span>, X_{ij} are a vector of covariates with
coefficients <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\phi_i\)</span> i.i.d. random effects and <span class="math inline">\(\epsilon_{ij}\)</span> a Gaussian error term. The
distribution of the random effects <span class="math inline">\(\phi_i\)</span> is Gaussian with zero mean and
precision <span class="math inline">\(\tau_{\phi}\)</span>.</p>
</div>
<div class="section level2">
<h2 id="multilevel-modelling">Multilevel Modelling<a class="anchor" aria-label="anchor" href="#multilevel-modelling"></a>
</h2>
<p>Multilevel models are a particular type of mixed-effects models in
which observations are nested within groups, so that group effects are
modelled using random effects. A typical example is that of students
nested within classes.</p>
<p>For the next example, the <code>nlschools</code> data set (in package
<code>MASS</code>) will be used. This data set records data about
students’ performance (in particular, about a language score test) and
other variables. The variables in this data set are:</p>
<ul>
<li><p><code>lang</code>, language score test.</p></li>
<li><p><code>IQ</code>, verbal IQ.</p></li>
<li><p><code>class</code>, class ID.</p></li>
<li><p><code>GS</code>, class size as number of eighth-grade pupils
recorded in the class.</p></li>
<li><p><code>SES</code>, social-economic status of pupil’s
family.</p></li>
<li><p><code>COMB</code>, whether the pupils are taught in the
multi-grade class with 7th-grade students.</p></li>
</ul>
<p>The data set can be loaded and summarised as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">"MASS"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"nlschools"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nlschools</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       lang             IQ            class            GS             SES       </span></span>
<span><span class="co">##  Min.   : 9.00   Min.   : 4.00   15580  :  33   Min.   :10.00   Min.   :10.00  </span></span>
<span><span class="co">##  1st Qu.:35.00   1st Qu.:10.50   5480   :  31   1st Qu.:23.00   1st Qu.:20.00  </span></span>
<span><span class="co">##  Median :42.00   Median :12.00   15980  :  31   Median :27.00   Median :27.00  </span></span>
<span><span class="co">##  Mean   :40.93   Mean   :11.83   16180  :  31   Mean   :26.51   Mean   :27.81  </span></span>
<span><span class="co">##  3rd Qu.:48.00   3rd Qu.:13.00   18380  :  31   3rd Qu.:31.00   3rd Qu.:35.00  </span></span>
<span><span class="co">##  Max.   :58.00   Max.   :18.00   5580   :  30   Max.   :39.00   Max.   :50.00  </span></span>
<span><span class="co">##                                  (Other):2100                                  </span></span>
<span><span class="co">##  COMB    </span></span>
<span><span class="co">##  0:1658  </span></span>
<span><span class="co">##  1: 629  </span></span>
<span><span class="co">##          </span></span>
<span><span class="co">##          </span></span>
<span><span class="co">##          </span></span>
<span><span class="co">##          </span></span>
<span><span class="co">## </span></span></code></pre>
<p>The model to fit will take <code>lang</code> as the response variable
and include <code>IQ</code>, <code>GS</code>, <code>SES</code> and
<code>COMB</code> as covariates (i.e., fixed effects). This model can
easily be fit with <code>BayesX</code> (using the <code>R2BayesX</code>
package) as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"R2BayesX"</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html" class="external-link">bayesx</a></span><span class="op">(</span><span class="va">lang</span> <span class="op">~</span> <span class="va">IQ</span> <span class="op">+</span> <span class="va">GS</span> <span class="op">+</span>  <span class="va">SES</span> <span class="op">+</span> <span class="va">COMB</span>, data <span class="op">=</span> <span class="va">nlschools</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## bayesx(formula = lang ~ IQ + GS + SES + COMB, data = nlschools)</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Fixed effects estimation results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##                Mean      Sd    2.5%     50%   97.5%</span></span>
<span><span class="co">## (Intercept)  9.7059  1.0630  7.6150  9.7073 11.7042</span></span>
<span><span class="co">## IQ           2.3878  0.0723  2.2494  2.3892  2.5301</span></span>
<span><span class="co">## GS          -0.0263  0.0246 -0.0735 -0.0261  0.0227</span></span>
<span><span class="co">## SES          0.1483  0.0143  0.1195  0.1488  0.1754</span></span>
<span><span class="co">## COMB1       -1.6901  0.3123 -2.3009 -1.6999 -1.0776</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Scale estimate:</span></span>
<span><span class="co">##           Mean      Sd    2.5%     50% 97.5%</span></span>
<span><span class="co">## Sigma2 48.0652  1.4518 45.2863 48.0170 51.07</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## N = 2287  burnin = 2000  method = MCMC  family = gaussian  </span></span>
<span><span class="co">## iterations = 12000  step = 10</span></span></code></pre>
<p>Note that the previous model only includes fixed effects. The data
set includes <code>class</code> as the class ID to which each student
belongs. Class effects can have an impact on the performance of the
students, with students in the same class performing similarly in the
language test.</p>
<p>Very conveniently, <code>Bayesx</code> can include random effects in
the model by adding a term in the right hand side of the formula that
defined the model. Specifically, the term to add is
<code>sx(class, bs = "re")</code> (see code below for the full model).
This will create a random effect indexed over variable
<code>class</code> and which is of type <code>re</code>, i.e., it
provides random effects which are independent and identically
distributed using a normal distribution with zero mean and precision
<span class="math inline">\(\tau\)</span> - there are clear similarities
with a residual terms here (although that is at the observation level,
rather than the group level).</p>
<p>Before fitting the model, the between-class variability can be
explored by means of boxplots:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">lang</span> <span class="op">~</span> <span class="va">class</span>, data <span class="op">=</span> <span class="va">nlschools</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="p7_files/figure-html/unnamed-chunk-3-1.png" width="1440"></p>
<p>The code to fit the model with random effects is:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html" class="external-link">bayesx</a></span><span class="op">(</span></span>
<span>  <span class="va">lang</span> <span class="op">~</span> <span class="va">IQ</span> <span class="op">+</span> <span class="va">GS</span> <span class="op">+</span>  <span class="va">SES</span> <span class="op">+</span> <span class="va">COMB</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/sx.html" class="external-link">sx</a></span><span class="op">(</span><span class="va">class</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">nlschools</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## bayesx(formula = lang ~ IQ + GS + SES + COMB + sx(class, bs = "re"), </span></span>
<span><span class="co">##     data = nlschools)</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Fixed effects estimation results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##                Mean      Sd    2.5%     50%   97.5%</span></span>
<span><span class="co">## (Intercept) 10.6158  1.4532  7.8300 10.5345 13.5842</span></span>
<span><span class="co">## IQ           2.2460  0.0749  2.1000  2.2481  2.3950</span></span>
<span><span class="co">## GS          -0.0154  0.0477 -0.1069 -0.0162  0.0746</span></span>
<span><span class="co">## SES          0.1652  0.0149  0.1359  0.1653  0.1966</span></span>
<span><span class="co">## COMB1       -1.9744  0.5852 -3.1245 -1.9681 -0.8178</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Random effects variances:</span></span>
<span><span class="co">##                 Mean      Sd    2.5%     50%   97.5%     Min    Max</span></span>
<span><span class="co">## sx(class):re  8.6044  1.3576  6.1081  8.5338 11.4041  5.0351 14.372</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Scale estimate:</span></span>
<span><span class="co">##           Mean      Sd    2.5%     50%  97.5%</span></span>
<span><span class="co">## Sigma2 40.0422  1.1947 37.7744 40.0373 42.308</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## N = 2287  burnin = 2000  method = MCMC  family = gaussian  </span></span>
<span><span class="co">## iterations = 12000  step = 10</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="generalised-linear-mixed-models">Generalised Linear Mixed Models<a class="anchor" aria-label="anchor" href="#generalised-linear-mixed-models"></a>
</h2>
<p>Mixed effects models can also be considered within the context of
generalised linear models. In this case, the linear predictor of
observation <span class="math inline">\(i\)</span>, <span class="math inline">\(\eta_i\)</span>, can be defined as</p>
<p><span class="math display">\[
\eta_i = X_{ij}\beta +\phi_i
\]</span></p>
<p>Compared to the previous setting of linear mixed effects models, note
that now the distribution of the response could be other than Gaussian
and that observations are not necessarily nested within groups.</p>
</div>
<div class="section level2">
<h2 id="poisson-regression">Poisson regression<a class="anchor" aria-label="anchor" href="#poisson-regression"></a>
</h2>
<p>In this practical we will use the North Carolina Sudden Infant Death
Syndrome (SIDS) data set. It is available in the <code>spData</code>
package and it can be loaded using:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/spData/" class="external-link">spData</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     CNTY.ID         BIR74           SID74          NWBIR74      </span></span>
<span><span class="co">##  Min.   :1825   Min.   :  248   Min.   : 0.00   Min.   :   1.0  </span></span>
<span><span class="co">##  1st Qu.:1902   1st Qu.: 1077   1st Qu.: 2.00   1st Qu.: 190.0  </span></span>
<span><span class="co">##  Median :1982   Median : 2180   Median : 4.00   Median : 697.5  </span></span>
<span><span class="co">##  Mean   :1986   Mean   : 3300   Mean   : 6.67   Mean   :1051.0  </span></span>
<span><span class="co">##  3rd Qu.:2067   3rd Qu.: 3936   3rd Qu.: 8.25   3rd Qu.:1168.5  </span></span>
<span><span class="co">##  Max.   :2241   Max.   :21588   Max.   :44.00   Max.   :8027.0  </span></span>
<span><span class="co">##      BIR79           SID79          NWBIR79             east      </span></span>
<span><span class="co">##  Min.   :  319   Min.   : 0.00   Min.   :    3.0   Min.   : 19.0  </span></span>
<span><span class="co">##  1st Qu.: 1336   1st Qu.: 2.00   1st Qu.:  250.5   1st Qu.:178.8  </span></span>
<span><span class="co">##  Median : 2636   Median : 5.00   Median :  874.5   Median :285.0  </span></span>
<span><span class="co">##  Mean   : 4224   Mean   : 8.36   Mean   : 1352.8   Mean   :271.3  </span></span>
<span><span class="co">##  3rd Qu.: 4889   3rd Qu.:10.25   3rd Qu.: 1406.8   3rd Qu.:361.2  </span></span>
<span><span class="co">##  Max.   :30757   Max.   :57.00   Max.   :11631.0   Max.   :482.0  </span></span>
<span><span class="co">##      north             x                 y             lon        </span></span>
<span><span class="co">##  Min.   :  6.0   Min.   :-328.04   Min.   :3757   Min.   :-84.08  </span></span>
<span><span class="co">##  1st Qu.: 97.0   1st Qu.: -60.55   1st Qu.:3920   1st Qu.:-81.20  </span></span>
<span><span class="co">##  Median :125.5   Median : 114.38   Median :3963   Median :-79.26  </span></span>
<span><span class="co">##  Mean   :122.1   Mean   :  91.46   Mean   :3953   Mean   :-79.51  </span></span>
<span><span class="co">##  3rd Qu.:151.5   3rd Qu.: 240.03   3rd Qu.:4000   3rd Qu.:-77.87  </span></span>
<span><span class="co">##  Max.   :182.0   Max.   : 439.65   Max.   :4060   Max.   :-75.67  </span></span>
<span><span class="co">##       lat             L.id           M.id     </span></span>
<span><span class="co">##  Min.   :33.92   Min.   :1.00   Min.   :1.00  </span></span>
<span><span class="co">##  1st Qu.:35.26   1st Qu.:1.00   1st Qu.:2.00  </span></span>
<span><span class="co">##  Median :35.68   Median :2.00   Median :3.00  </span></span>
<span><span class="co">##  Mean   :35.62   Mean   :2.12   Mean   :2.67  </span></span>
<span><span class="co">##  3rd Qu.:36.05   3rd Qu.:3.00   3rd Qu.:3.25  </span></span>
<span><span class="co">##  Max.   :36.52   Max.   :4.00   Max.   :4.00</span></span></code></pre>
<p>A full description of the data set is provided in the associated
manual page (check with <code><a href="https://jakubnowosad.com/spData/reference/nc.sids.html" class="external-link">?nc.sids</a></code>) but in this practical we
will only consider these variables:</p>
<ul>
<li><p><code>BIR74</code>, number of births (1974-78).</p></li>
<li><p><code>SID74</code>, number of SID deaths (1974-78).</p></li>
<li><p><code>NWBIR74</code>, number of non-white births
(1974-78).</p></li>
</ul>
<p>These variables are measured at the county level in North Carolina,
of which there are 100.</p>
<p>Because <code>SID74</code> records the number of SID deaths, the
model is Poisson:</p>
<p><span class="math display">\[
O_i \mid \mu_i \sim Po(\mu_i),\ i=1,\ldots, 100
\]</span> Here, <span class="math inline">\(O_i\)</span> represents the
number of cases in county <span class="math inline">\(i\)</span> and
<span class="math inline">\(\mu_i\)</span> the mean. In addition, mean
<span class="math inline">\(\mu_i\)</span> will be written as <span class="math inline">\(\mu_i = E_i \theta_i\)</span>, where <span class="math inline">\(E_i\)</span> is the <em>expected</em> number of
cases and <span class="math inline">\(\theta_i\)</span> the relative
risk in county <span class="math inline">\(i\)</span>.</p>
<p>The relative risk <span class="math inline">\(\theta_i\)</span> is
often modelled, on the log-scale, to be equal to a linear predictor:</p>
<p><span class="math display">\[
\log(\theta_i) = \beta_0 + \ldots
\]</span></p>
<p>The expected number of cases is computed by multiplying the number of
births in county <span class="math inline">\(i\)</span> to the overall
mortality rate</p>
<p><span class="math display">\[
r = \frac{\sum_{i=1}^{100}O_i}{\sum_{i=1}^{100}B_i}
\]</span> where <span class="math inline">\(B_i\)</span> represents the
total number of births in country <span class="math inline">\(i\)</span>. Hence, the expected number of cases in
county <span class="math inline">\(i\)</span> is <span class="math inline">\(E_i = r B_i\)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Overall mortality rate</span></span>
<span><span class="va">r74</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">SID74</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">BIR74</span><span class="op">)</span></span>
<span><span class="co"># Expected cases</span></span>
<span><span class="va">nc.sids</span><span class="op">$</span><span class="va">EXP74</span> <span class="op">&lt;-</span> <span class="va">r74</span> <span class="op">*</span> <span class="va">nc.sids</span><span class="op">$</span><span class="va">BIR74</span></span></code></pre></div>
<p>A common measure of relative risk is the <em>standardised mortality
ratio</em> (<span class="math inline">\(O_i / E_i\)</span>):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc.sids</span><span class="op">$</span><span class="va">SMR74</span> <span class="op">&lt;-</span> <span class="va">nc.sids</span><span class="op">$</span><span class="va">SID74</span> <span class="op">/</span> <span class="va">nc.sids</span><span class="op">$</span><span class="va">EXP74</span></span></code></pre></div>
<p>A summary of the SMR can be obtained:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">SMR</span>, xlab <span class="op">=</span> <span class="st">"SMR"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p7_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Values above 1 indicate that the county has more observed deaths than
expected and that there might be an increased risk in the area.</p>
<p>As a covariate, we will compute the proportion of non-white
births:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc.sids</span><span class="op">$</span><span class="va">NWPROP74</span> <span class="op">&lt;-</span> <span class="va">nc.sids</span><span class="op">$</span><span class="va">NWBIR74</span><span class="op">/</span> <span class="va">nc.sids</span><span class="op">$</span><span class="va">BIR74</span></span></code></pre></div>
<p>There is a clear relationship between the SMR and the proportion of
non-white births in a county:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">NWPROP74</span>, <span class="va">nc.sids</span><span class="op">$</span><span class="va">SMR74</span><span class="op">)</span></span></code></pre></div>
<p><img src="p7_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Correlation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">NWPROP74</span>, <span class="va">nc.sids</span><span class="op">$</span><span class="va">SMR74</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.5793901</span></span></code></pre>
<p>A simple Poisson regression can be fit by using the following
code:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html" class="external-link">bayesx</a></span><span class="op">(</span></span>
<span>  <span class="va">SID74</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">NWPROP74</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">EXP74</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">nc.sids</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m1nc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## bayesx(formula = SID74 ~ 1 + NWPROP74, data = nc.sids, offset = log(nc.sids$EXP74), </span></span>
<span><span class="co">##     family = "poisson")</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Fixed effects estimation results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##                Mean      Sd    2.5%     50%   97.5%</span></span>
<span><span class="co">## (Intercept) -0.6463  0.0906 -0.8189 -0.6458 -0.4542</span></span>
<span><span class="co">## NWPROP74     1.8710  0.2206  1.4250  1.8681  2.3064</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## N = 100  burnin = 2000  method = MCMC  family = poisson  </span></span>
<span><span class="co">## iterations = 12000  step = 10</span></span></code></pre>
<p>Random effects can also be included to account for intrinsic
differences between the counties:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Index for random effects</span></span>
<span><span class="va">nc.sids</span><span class="op">$</span><span class="va">ID</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model WITH covariate</span></span>
<span><span class="va">m2nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html" class="external-link">bayesx</a></span><span class="op">(</span></span>
<span>  <span class="va">SID74</span> <span class="op">~</span>  <span class="fl">1</span> <span class="op">+</span> <span class="va">NWPROP74</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/sx.html" class="external-link">sx</a></span><span class="op">(</span><span class="va">ID</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">EXP74</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m2nc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## bayesx(formula = SID74 ~ 1 + NWPROP74 + sx(ID, bs = "re"), data = as.data.frame(nc.sids), </span></span>
<span><span class="co">##     offset = log(nc.sids$EXP74), family = "poisson")</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Fixed effects estimation results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##                Mean      Sd    2.5%     50%   97.5%</span></span>
<span><span class="co">## (Intercept) -0.6617  0.1067 -0.8720 -0.6661 -0.4590</span></span>
<span><span class="co">## NWPROP74     1.9076  0.2624  1.3904  1.9105  2.4407</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Random effects variances:</span></span>
<span><span class="co">##             Mean     Sd   2.5%    50%  97.5%    Min    Max</span></span>
<span><span class="co">## sx(ID):re 0.0571 0.0298 0.0059 0.0551 0.1210 0.0012 0.1709</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## N = 100  burnin = 2000  method = MCMC  family = poisson  </span></span>
<span><span class="co">## iterations = 12000  step = 10</span></span></code></pre>
<p>We can see the fitted relationship with <code>NWPROP74</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x.predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,length<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">y.predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">m2nc</span><span class="op">)</span><span class="op">[</span><span class="st">"(Intercept)"</span>,<span class="st">"Mean"</span><span class="op">]</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">m2nc</span><span class="op">)</span><span class="op">[</span><span class="st">"NWPROP74"</span>,<span class="st">"Mean"</span><span class="op">]</span><span class="op">*</span><span class="va">x.predict</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">NWPROP74</span>, <span class="va">nc.sids</span><span class="op">$</span><span class="va">SMR74</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x.predict</span>,<span class="va">y.predict</span><span class="op">)</span></span></code></pre></div>
<p><img src="p7_files/figure-html/unnamed-chunk-13-1.png" width="700">
The role of the covariate can be explored by fitting a model without
it:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model WITHOUT covariate</span></span>
<span><span class="va">m3nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/bayesx.html" class="external-link">bayesx</a></span><span class="op">(</span></span>
<span>  <span class="va">SID74</span> <span class="op">~</span>  <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/R2BayesX/man/sx.html" class="external-link">sx</a></span><span class="op">(</span><span class="va">ID</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">$</span><span class="va">EXP74</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">nc.sids</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m3nc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## bayesx(formula = SID74 ~ 1 + sx(ID, bs = "re"), data = as.data.frame(nc.sids), </span></span>
<span><span class="co">##     offset = log(nc.sids$EXP74), family = "poisson")</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Fixed effects estimation results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##                Mean      Sd    2.5%     50%  97.5%</span></span>
<span><span class="co">## (Intercept) -0.0317  0.0651 -0.1665 -0.0298 0.0864</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## Random effects variances:</span></span>
<span><span class="co">##             Mean     Sd   2.5%    50%  97.5%    Min    Max</span></span>
<span><span class="co">## sx(ID):re 0.1743 0.0530 0.0914 0.1680 0.2973 0.0454 0.3867</span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## N = 100  burnin = 2000  method = MCMC  family = poisson  </span></span>
<span><span class="co">## iterations = 12000  step = 10</span></span></code></pre>
<p>Now, notice the decrease in the estimate of the precision of the
random effects (i.e., the variance increases). This means that values of
the random effects are now larger than in the previous case as the
random effects pick some of the effect explained by the covariate.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">m2nc</span><span class="op">$</span><span class="va">effects</span><span class="op">$</span><span class="va">`sx(ID):re`</span><span class="op">$</span><span class="va">Mean</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"With NWPROP74"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">m3nc</span><span class="op">$</span><span class="va">effects</span><span class="op">$</span><span class="va">`sx(ID):re`</span><span class="op">$</span><span class="va">Mean</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Without NWPROP74"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p7_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="further-extensions">Further Extensions<a class="anchor" aria-label="anchor" href="#further-extensions"></a>
</h2>
<p>Spatial random effects can be defined not to be independent and
identically distributed. Instead, spatial or temporal correlation can be
considered when defining them. For example, in the North Carolina SIDS
data set, it is common to consider that two counties that are neighbours
(i.e., share a boundary) will have similar relative risks. This can be
taken into account in the model but assuming that the random effects are
spatially autocorrelated. This is out of the scope of this introductory
course but feel free to ask about this!!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by VIBASS7, Facundo Muñoz.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
